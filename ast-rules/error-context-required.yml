id: error-context-required
language: rust
message: "エラーにコンテキスト情報を追加してください"
note: ".context()や.with_context()を使用してエラーに詳細情報を追加してください"
severity: warning
rule:
  all:
    # ?演算子の使用
    - pattern: $EXPR?
    # Result<T, E>を返しそうな操作
    - any:
        # ファイル操作
        - regex: "(fs::|File::|OpenOptions::)"
        # ネットワーク操作
        - regex: "(connect|bind|listen|send|recv)"
        # パース操作
        - regex: "(parse|from_str|deserialize)"
    # contextメソッドが使われていない
    - not:
        regex: '\\.(context|with_context)\\(.*\\)'
  not:
    any:
      # ignoreコメントがある場合は除外
      - precedes:
          regex: '//\\s*ast-grep-ignore'
      # テストモジュール内は例外
      - inside:
          all:
            - kind: mod_item
            - has:
                regex: 'cfg\\(\\s*test\\s*\\)'
      # 既にexpectやunwrap_or等でハンドリングしている場合
      - regex: '\\.(expect|unwrap_or|unwrap_or_else|unwrap_or_default)\\(.*\\)'
