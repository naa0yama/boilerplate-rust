id: no-ignored-result
language: rust
message: "Result型の戻り値が無視されています (project_rules.md 2.3)"
note: "Result<T, E>を返す関数の結果は必ず処理してください: .expect(), .unwrap_or(), match, ?演算子"
severity: error
rule:
  all:
    # 関数呼び出し式
    - kind: expression_statement
    # Result<T, E>を返す可能性のあるパターン
    - any:
        # メソッドチェーンの結果を無視
        - pattern: $OBJ.$METHOD($$$ARGS);
        # 関数呼び出しの結果を無視
        - pattern: $FUNC($$$ARGS);
    # Resultを返しそうな関数のパターンのみ検出
    - any:
        # よくある関数名
        - regex: "(read|write|send|recv|connect|bind|listen|accept|parse|deserialize|serialize|try_)"
        # fs操作
        - regex: "fs::(read|write|create|remove|copy|rename)"
        # tokio系
        - regex: "(tokio::|async)"
        # ファイル操作
        - regex: "(File::|OpenOptions::)"
    # 例外：以下は許可
    - not:
        any:
          # 明示的に戻り値を破棄 (let _ = ...)
          - inside:
              pattern: let _ = $EXPR
          # 既に?演算子を使用
          - regex: '\\?\\s*;$'
          # print系は除外
          - regex: "(print|trace|debug|info|warn|error)!"
          # init()系は除外（初期化処理）
          - regex: '\\.init\\(.*\\)'
          # テストモジュール内は例外
          - inside:
              all:
                - kind: mod_item
                - has:
                    regex: 'cfg\\(\\s*test\\s*\\)'
