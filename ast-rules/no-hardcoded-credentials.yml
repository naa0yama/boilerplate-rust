id: no-hardcoded-credentials
language: rust
message: "ハードコードされた認証情報の可能性があります"
note: "環境変数やconfigファイルから読み込むようにしてください"
severity: error
rule:
  any:
    # よくあるパスワード・キー変数名
    - all:
        - kind: let_declaration
        - regex: '(password|passwd|pwd|secret|key|token|credential|PASSWORD|PASSWD|PWD|SECRET|KEY|TOKEN|CREDENTIAL)'
        - has:
            all:
              - kind: string_literal
              - regex: '.{8,}' # 8文字以上の文字列
    # APIキーっぽい文字列
    - all:
        - kind: string_literal
        - regex: '(sk-[a-zA-Z0-9]{20,}|pk-[a-zA-Z0-9]{20,}|AKIA[0-9A-Z]{16}|eyJ[a-zA-Z0-9].*|[a-zA-Z0-9]{32,})'
  not:
    any:
      # ignoreコメントがある場合は除外
      - precedes:
          regex: '//\\s*ast-grep-ignore'
      # テストモジュール内は例外
      - inside:
          all:
            - kind: mod_item
            - has:
                regex: 'cfg\\(\\s*test\\s*\\)'
      # 短い文字列（false positive回避）
      - regex: '^.{1,7}$'
      # 明らかにテスト用の値
      - regex: '(test|demo|example|sample)'