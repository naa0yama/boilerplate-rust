id: prefer-vec-with-capacity
language: rust
message: "ループ内でVec::push()を使用する場合はVec::with_capacity()を検討してください"
note: "事前にサイズが分かる場合、Vec::with_capacity(size)で再割り当てを防げます"
severity: warning
rule:
  all:
    # Vec::new()でベクターを初期化
    - pattern: let $VAR = Vec::new()
    # その後でループ内でpushを使用
    - follows:
        any:
          # for文内でのpush
          - inside:
              all:
                - kind: for_expression
                - has:
                    pattern: $VAR.push($$$)
          # while文内でのpush
          - inside:
              all:
                - kind: while_expression
                - has:
                    pattern: $VAR.push($$$)
    # 除外条件
    - not:
        any:
          # 既にignoreコメントがある場合
          - precedes:
              regex: '//\\s*ast-grep-ignore'
          # テストモジュール内は例外
          - inside:
              all:
                - kind: mod_item
                - has:
                    regex: 'cfg\\(\\s*test\\s*\\)'