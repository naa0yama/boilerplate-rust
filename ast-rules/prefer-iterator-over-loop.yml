id: prefer-iterator-over-loop
language: rust
message: "単純なfor文よりもイテレータチェーンの使用を検討してください"
note: ".iter().map()/.filter()/.collect()等のイテレータメソッドを使用するとより関数的で効率的です"
severity: info
rule:
  all:
    # for文
    - pattern: |
        for $ITEM in $COLLECTION {
          $$$BODY
        }
    # 単純な変換処理（push操作）
    - has:
        pattern: $VAR.push($$$)
    # コレクション初期化がある
    - precedes:
        any:
          - pattern: let mut $VAR = Vec::new()
          - pattern: let mut $VAR = Vec::with_capacity($$$)
  not:
    any:
      # ignoreコメントがある場合は除外
      - precedes:
          regex: '//\\s*ast-grep-ignore'
      # テストモジュール内は例外
      - inside:
          all:
            - kind: mod_item
            - has:
                regex: 'cfg\\(\\s*test\\s*\\)'
      # 複雑な制御フロー（continue, break）がある場合は除外
      - has:
          any:
            - kind: continue_expression
            - kind: break_expression